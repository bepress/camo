version: 2
jobs:
    build:
        docker:
            # This image for leche is just go1.9 with python and aws cli
            # installed. So ignore the name for now and we'll make a
            # generically named bepress image RSNâ„¢.
            - image: reed/leche:latest
        working_directory: /go/src/github.com/bepress/camo

        environment:
            TEST_RESULTS: /tmp/test-results

        steps:
            - checkout

            - run: mkdir -p $TEST_RESULTS

            - run:
                name: Get packages
                command: |
                  go get github.com/jstemmer/go-junit-report
                  make dependencies

            - run:
                name: Lint and static analysis
                command:
                    make lint

            - run:
                name: Run unit tests
                command: |
                    trap "go-junit-report <${TEST_RESULTS}/go-test.out > ${TEST_RESULTS}/go-test-report.xml" EXIT
                    make test-race |tee ${TEST_RESULTS}/go-test.out
            - deploy:
                name: Upload build artifact - maybe
                command: |
                    if [ "${CIRCLE_BRANCH}" == "master" ]; then
                        # make master
                        echo "skipped build on master"
                    fi
                    if [ -n "${CIRCLE_TAG}" ]; then
                        make release
                        make deploy_staging
                    fi

            - store_artifacts:
                path: /tmp/test-results
                destination: raw-test-output

            - store_test_results:
                path: /tmp/test-results
    release:
        docker:
            - image: bepress/deploy:latest
        working_directory: /tmp/

        steps:
            - checkout
            - deploy:
                name: Deploy to production
                command: |
                    make promote_production
                    make deploy_production

workflows:
  version: 2
  build-workflow:
    jobs:
      - build:
          filters:
            tags:
              only: /.*/
      - hold:
          type: approval
          requires:
            - build
          filters:
            tags:
              only: /.*/
            branches:
              only:
                - master
      - release:
          requires:
            - hold
          filters:
            tags:
              only: /.*/
            branches:
              only:
                - master
